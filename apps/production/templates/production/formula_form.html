<!-- C:\Users\Adeyanju Joshua\Desktop\lexy sofware\accounting_system_2\apps\production\templates\production\formula_form.html -->
{% extends 'base.html' %}
{% load static %}
{% load production_tags %}
{% load currency_filters %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div>
            <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>
    </div>
    <div class="card card-professional">
        <div class="card-body">
            <form method="post" id="formulaForm">
                {% csrf_token %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.name.id_for_label }}" class="form-label">Formula Name</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="text-danger">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="finished_product_search" class="form-label">Finished Product</label>
                        <div class="position-relative">
                            <input type="text" id="finished_product_search"
                                class="form-control"
                                placeholder="Search finished products..."
                                value="{% if form.instance and form.instance.finished_product %}{{ form.instance.finished_product.name }}{% endif %}"
                                data-initial-id="{% if form.instance and form.instance.finished_product %}{{ form.instance.finished_product.id }}{% endif %}"
                                data-initial-unit="{% if form.instance and form.instance.finished_product %}{{ form.instance.finished_product.unit_of_measurement }}{% endif %}">
                            {{ form.finished_product }}
                            <div id="finished-product-dropdown" class="dropdown-menu w-100"></div>
                        </div>
                        {% if form.finished_product.errors %}
                        <div class="text-danger">{{ form.finished_product.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.unit_quantity.id_for_label }}" class="form-label">Output Quantity</label>
                        <div class="input-group">
                            {{ form.unit_quantity }}
                            <span class="input-group-text" id="output-unit-text">
                                <span id="output-unit">Units</span>
                            </span>
                        </div>
                        {% if form.unit_quantity.errors %}
                        <div class="text-danger">{{ form.unit_quantity.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">How many units this formula produces</small>
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.labor_cost.id_for_label }}" class="form-label">Labor Cost</label>
                        <div class="input-group">
                            <span class="input-group-text">{{ currency_symbol }}</span>
                            {{ form.labor_cost }}
                        </div>
                        {% if form.labor_cost.errors %}
                        <div class="text-danger">{{ form.labor_cost.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Labor cost per unit produced</small>
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.overhead_cost.id_for_label }}" class="form-label">Overhead Cost</label>
                        <div class="input-group">
                            <span class="input-group-text">{{ currency_symbol }}</span>
                            {{ form.overhead_cost }}
                        </div>
                        {% if form.overhead_cost.errors %}
                        <div class="text-danger">{{ form.overhead_cost.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Overhead cost per unit produced</small>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-check mb-4">
                    {{ form.is_active }}
                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                        Active Formula
                    </label>
                </div>
                <h4 class="mb-3">Ingredients</h4>
                {{ formset.management_form }}
                <div class="table-responsive">
                    <table class="table table-bordered" id="ingredients-table">
                        <thead>
                            <tr>
                                <th style="width: 35%">Material</th>
                                <th style="width: 15%">Quantity</th>
                                <th style="width: 15%">Unit</th>
                                <th style="width: 25%">Notes</th>
                                <th style="width: 10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredients-tbody">
                            {% for form in formset.forms %}
                                <tr class="ingredient-form">
                                    <td>
                                        {{ form.id }}
                                        {{ form.material }}
                                        <div class="position-relative">
                                            <input type="text"
                                                name="{{ form.material_search.name }}"
                                                value="{% if form.instance.material %}{{ form.instance.material.name }}{% elif form.material.value %}{% with mat=form.material.value %}{% for item in inventory_items %}{% if item.id|stringformat:"s" == mat %}{{ item.name }}{% endif %}{% endfor %}{% endwith %}{% else %}{{ form.material_search.value|default_if_none:'' }}{% endif %}"
                                                class="form-control material-search-input"
                                                placeholder="Search materials..."
                                                data-initial-name="{% if form.instance.material %}{{ form.instance.material.name }}{% elif form.material.value %}{% with mat=form.material.value %}{% for item in inventory_items %}{% if item.id|stringformat:"s" == mat %}{{ item.name }}{% endif %}{% endfor %}{% endwith %}{% endif %}"
                                                data-initial-unit="{% if form.instance.material %}{{ form.instance.material.unit_of_measurement }}{% elif form.material.value %}{% with mat=form.material.value %}{% for item in inventory_items %}{% if item.id|stringformat:"s" == mat %}{{ item.unit_of_measurement }}{% endif %}{% endfor %}{% endwith %}{% endif %}">
                                            <div id="material-dropdown-{{ forloop.counter0 }}" class="dropdown-menu material-dropdown"></div>
                                        </div>
                                        {% if form.material.errors %}
                                        <div class="text-danger">{{ form.material.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.quantity }}
                                        {% if form.quantity.errors %}
                                        <div class="text-danger">{{ form.quantity.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="unit-display">
                                        <span class="unit-text" id="unit-text-{{ forloop.counter0 }}"></span>
                                    </td>
                                    <td>
                                        {{ form.notes }}
                                        {% if form.notes.errors %}
                                        <div class="text-danger">{{ form.notes.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons-boxed">
                                            {% if form.instance.pk %}
                                                <span style="display:none;">{{ form.DELETE }}</span>
                                            {% endif %}
                                            <button type="button" class="action-btn action-btn-delete remove-ingredient">
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end align-items-center mt-3 gap-2">
                    <button type="button" class="btn btn-outline-primary me-2" id="add-ingredient" style="order:2;">
                        Add Ingredient
                    </button>
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="goBack()" style="order:3;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="order:4;">Save Formula</button>
                </div>
            </form>
        </div>
    </div>
</div>
<template id="empty-form-template">
    <tr class="ingredient-form">
        <td>
            <!-- THIS IS THE NEW FIX: MOVED THE ID INTO THE TD -->
            {{ formset.empty_form.id }}
            {{ formset.empty_form.material }}
            <div class="position-relative">
                {{ formset.empty_form.material_search }}
                <div class="material-dropdown dropdown-menu"></div>
            </div>
        </td>
        <td>
            {{ formset.empty_form.quantity }}
        </td>
        <td class="unit-display">
            <span class="unit-text"></span>
        </td>
        <td>
            {{ formset.empty_form.notes }}
        </td>
        <td class="text-center">
            <div class="action-buttons-boxed">
                <button type="button" class="action-btn action-btn-delete remove-ingredient">
                    Delete
                </button>
            </div>
        </td>
    </tr>
</template>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DEBUG: Log page load ---
        console.log('[DEBUG] Production formula form loaded');

        const addIngredientBtn = document.getElementById('add-ingredient');
        const ingredientsTbody = document.getElementById('ingredients-tbody');
        const formTemplate = document.getElementById('empty-form-template');
        const finishedProductSelect = document.getElementById('{{ form.finished_product.id_for_label }}');
        const finishedProductSearch = document.getElementById('finished_product_search');
        const finishedProductDropdown = document.getElementById('finished-product-dropdown');
        const outputUnitSpan = document.getElementById('output-unit');

        // --- FINISHED PRODUCT SEARCH LOGIC ---
        if (finishedProductSelect && finishedProductSearch) {
            finishedProductSelect.style.display = 'none';

            // --- DEBUG: Initial finished product values ---
            console.log('[DEBUG] FinishedProductSelect.value:', finishedProductSelect.value);
            console.log('[DEBUG] FinishedProductSearch.value:', finishedProductSearch.value);

            // Set initial value if one is selected (Edit mode)
            if (finishedProductSelect.value) {
                // If using a select element (rare, since you use HiddenInput), fallback to data attributes
                const selectedOption = finishedProductSelect.options ? finishedProductSelect.options[finishedProductSelect.selectedIndex] : null;
                if (selectedOption && selectedOption.text) {
                    finishedProductSearch.value = selectedOption.text;
                    console.log('[DEBUG] FinishedProductSearch set from select option:', selectedOption.text);
                }
                // Always fetch unit for selected product
                fetch(`/inventory/ajax/item/${finishedProductSelect.value}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.unit_of_measurement) {
                            outputUnitSpan.textContent = data.unit_of_measurement;
                            console.log('[DEBUG] Output unit set from AJAX:', data.unit_of_measurement);
                        }
                        if (!finishedProductSearch.value && data.name) {
                            finishedProductSearch.value = data.name;
                            console.log('[DEBUG] FinishedProductSearch set from AJAX:', data.name);
                        }
                    });
            }
            // Set unit from data attribute if available (Edit mode fix)
            if (finishedProductSearch.value) {
                outputUnitSpan.textContent = finishedProductSearch.dataset.initialUnit || "Units";
                console.log('[DEBUG] Output unit set from data attribute:', finishedProductSearch.dataset.initialUnit);
            }

            // --- SEARCH LOGIC ---
            finishedProductSearch.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length < 2) {
                    finishedProductDropdown.innerHTML = '';
                    finishedProductDropdown.classList.remove('show');
                    return;
                }
                fetch(`/inventory/api/items/search/?q=${encodeURIComponent(query)}&type=PRODUCT`)
                    .then(response => response.json())
                    .then(data => {
                        finishedProductDropdown.innerHTML = '';
                        if (!data.results || data.results.length === 0) {
                            const noResults = document.createElement('a');
                            noResults.className = 'dropdown-item disabled';
                            noResults.textContent = 'No products found';
                            finishedProductDropdown.appendChild(noResults);
                        } else {
                            data.results.forEach(item => {
                                const option = document.createElement('a');
                                option.className = 'dropdown-item';
                                option.href = '#';
                                option.textContent = item.name;
                                option.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    finishedProductSelect.value = item.id;
                                    finishedProductSearch.value = item.name;
                                    finishedProductDropdown.classList.remove('show');
                                    outputUnitSpan.textContent = item.unit_of_measurement || 'Units';
                                    console.log('[DEBUG] Finished product selected:', item.name, item.unit_of_measurement);
                                });
                                finishedProductDropdown.appendChild(option);
                            });
                        }
                        finishedProductDropdown.classList.add('show');
                    });
            });
            finishedProductSearch.addEventListener('focus', function() {
                fetch('/inventory/api/items/search/?type=PRODUCT&all=1')
                    .then(response => response.json())
                    .then(data => {
                        finishedProductDropdown.innerHTML = '';
                        if (!data.results || data.results.length === 0) {
                            const noResults = document.createElement('a');
                            noResults.className = 'dropdown-item disabled';
                            noResults.textContent = 'No products found';
                            finishedProductDropdown.appendChild(noResults);
                        } else {
                            data.results.forEach(item => {
                                const option = document.createElement('a');
                                option.className = 'dropdown-item';
                                option.href = '#';
                                option.textContent = item.name;
                                option.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    finishedProductSelect.value = item.id;
                                    finishedProductSearch.value = item.name;
                                    finishedProductDropdown.classList.remove('show');
                                    outputUnitSpan.textContent = item.unit_of_measurement || 'Units';
                                    console.log('[DEBUG] Finished product selected (focus):', item.name, item.unit_of_measurement);
                                });
                                finishedProductDropdown.appendChild(option);
                            });
                        }
                        finishedProductDropdown.classList.add('show');
                    });
            });
            document.addEventListener('click', function(e) {
                if (!finishedProductSearch.contains(e.target) && !finishedProductDropdown.contains(e.target)) {
                    finishedProductDropdown.classList.remove('show');
                }
            });
        }

        // --- INGREDIENTS LOGIC ---
        let formCount = {{ formset.total_form_count }};
        addIngredientBtn.addEventListener('click', function() {
            const newForm = formTemplate.content.cloneNode(true);
            const regex = new RegExp('__prefix__', 'g');
            newForm.querySelectorAll('*[name], *[id], *[for]').forEach(el => {
                if (el.name) el.name = el.name.replace(regex, formCount);
                if (el.id) el.id = el.id.replace(regex, formCount);
                if (el.hasAttribute('for')) el.setAttribute('for', el.getAttribute('for').replace(regex, formCount));
            });
            const dropdownDiv = newForm.querySelector('.material-dropdown');
            if (dropdownDiv) {
                dropdownDiv.id = `material-dropdown-${formCount}`;
            }
            ingredientsTbody.appendChild(newForm);
            const newSearchField = ingredientsTbody.querySelector(`input[name="ingredients-${formCount}-material_search"]`);
            if (newSearchField) {
                initializeMaterialSearch(newSearchField, formCount);
            }
            formCount++;
            document.getElementById('id_ingredients-TOTAL_FORMS').value = formCount;
            const removeBtn = ingredientsTbody.lastElementChild.querySelector('.remove-ingredient');
            if (removeBtn) {
                removeBtn.addEventListener('click', removeIngredient);
            }
        });

        function removeIngredient(e) {
            const row = e.target.closest('.ingredient-form');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.display = 'none';
            } else {
                row.remove();
            }
        }
        document.querySelectorAll('.remove-ingredient').forEach(btn => {
            btn.addEventListener('click', removeIngredient);
        });

        function initializeMaterialSearch(searchField, index) {
            const materialInput = document.querySelector(`input[name="ingredients-${index}-material"]`);
            const dropdown = document.getElementById(`material-dropdown-${index}`);
            if (!materialInput || !dropdown) return;

            function showResults(results) {
                dropdown.innerHTML = '';
                if (!results || results.length === 0) {
                    const noResults = document.createElement('a');
                    noResults.className = 'dropdown-item disabled';
                    noResults.textContent = 'No materials found';
                    dropdown.appendChild(noResults);
                } else {
                    results.forEach(item => {
                        const option = document.createElement('a');
                        option.className = 'dropdown-item';
                        option.href = '#';
                        option.textContent = `${item.name} ${item.sku ? '(' + item.sku + ')' : ''}`;
                        option.addEventListener('click', function(e) {
                            e.preventDefault();
                            materialInput.value = item.id;
                            searchField.value = item.name;
                            const row = searchField.closest('.ingredient-form');
                            const unitDisplay = row.querySelector('.unit-text');
                            if (unitDisplay) {
                                unitDisplay.textContent = item.unit_of_measurement || '';
                            }
                            dropdown.classList.remove('show');
                            console.log('[DEBUG] Material selected:', item.name, item.unit_of_measurement);
                        });
                        dropdown.appendChild(option);
                    });
                }
                dropdown.classList.add('show');
            }

            searchField.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }
                fetch(`/inventory/api/items/search/?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        showResults(data.results || []);
                    });
            });
            searchField.addEventListener('focus', function() {
                fetch('/inventory/api/items/search/?all=1')
                    .then(response => response.json())
                    .then(data => {
                        showResults(data.results || []);
                    });
            });
            document.addEventListener('click', function(e) {
                if (!searchField.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // --- DEBUG: Pre-fill logic ---
            console.log('[DEBUG] Ingredient row', index, 'materialInput.value:', materialInput.value, 'searchField.dataset.initialName:', searchField.dataset.initialName);

            // Pre-fill for edit mode
            if (materialInput && materialInput.value) {
                fetch(`/inventory/ajax/item/${materialInput.value}/`)
                    .then(response => response.json())
                    .then(data => {
                        const row = searchField.closest('.ingredient-form');
                        const unitDisplay = row.querySelector('.unit-text');
                        if (unitDisplay && data.unit_of_measurement) {
                            unitDisplay.textContent = data.unit_of_measurement;
                            console.log('[DEBUG] Ingredient', index, 'unit set from AJAX:', data.unit_of_measurement);
                        }
                        searchField.value = data.name || '';
                        console.log('[DEBUG] Ingredient', index, 'searchField set from AJAX:', data.name);
                    });
            } else if (searchField.dataset.initialName) {
                searchField.value = searchField.dataset.initialName;
                const row = searchField.closest('.ingredient-form');
                const unitDisplay = row.querySelector('.unit-text');
                if (unitDisplay && searchField.dataset.initialUnit) {
                    unitDisplay.textContent = searchField.dataset.initialUnit;
                    console.log('[DEBUG] Ingredient', index, 'unit set from data attribute:', searchField.dataset.initialUnit);
                }
            }
        }

        // --- INIT ALL INGREDIENT SEARCH FIELDS ON PAGE LOAD ---
        document.querySelectorAll('input[name$="-material_search"]').forEach((field) => {
            const nameAttr = field.getAttribute('name');
            const index = nameAttr.split('-')[1];
            // --- DEBUG: Ingredient field info ---
            console.log('[DEBUG] Initializing ingredient field:', nameAttr, 'index:', index, 'value:', field.value, 'data-initial-name:', field.dataset.initialName, 'data-initial-unit:', field.dataset.initialUnit);
            initializeMaterialSearch(field, index);
        });
    });

    function goBack() {
        window.history.back();
    }
</script>
<style>
    .dropdown-menu { display: none; position: absolute; z-index: 1050; min-width: 10rem; padding: 0.5rem 0; margin: 0; font-size: 1rem; color: #212529; text-align: left; list-style: none; background-color: #fff; background-clip: padding-box; border: 1px solid rgba(0, 0, 0, 0.15); border-radius: 0.25rem; max-height: 200px; overflow-y: auto; }
    .dropdown-menu.show { display: block !important; }
    .position-relative { position: relative !important; }
    .material-dropdown { position: fixed !important; max-height: 200px; overflow-y: auto; width: auto !important; min-width: 250px; }
    .dropdown-item { display: block; width: 100%; padding: 0.25rem 1rem; clear: both; font-weight: 400; color: #212529; text-align: inherit; text-decoration: none; white-space: nowrap; background-color: transparent; border: 0; }
    .dropdown-item:hover, .dropdown-item:focus { color: #1e2125; background-color: #f8f9fa; text-decoration: none; }
    .dropdown-item.active, .dropdown-item:active { color: #fff; text-decoration: none; background-color: #0d6efd; }
    .unit-display { padding-top: 10px; text-align: center; font-weight: 500; }
    input.form-control { width: 100%; }
    .action-buttons-boxed { display: flex; flex-direction: column; gap: 2px; align-items: center; min-width: 80px; }
    .action-btn { display: inline-block; padding: 4px 12px; font-size: 11px; font-weight: 500; text-align: center; text-decoration: none; border: none; cursor: pointer; transition: all 0.2s ease; min-width: 60px; line-height: 1.2; border-radius: 4px; }
    .action-btn-view { background-color: #6c757d; color: white; }
    .action-btn-view:hover { background-color: #5a6268; color: white; text-decoration: none; }
    .action-btn-delete { background-color: #dc3545; color: white; }
    .action-btn-delete:hover { background-color: #c82333; color: white; text-decoration: none; }
</style>
{% endblock %}