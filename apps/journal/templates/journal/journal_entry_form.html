<!-- C:\Users\Adeyanju Joshua\Desktop\lexy sofware\accounting_system_2\apps\journal\templates\journal\journal_entry_form.html -->
{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Create Journal Entry{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header with Back Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1 text-dark">Create Manual Journal Entry</h2>
            <p class="text-muted mb-0">Create double-entry journal entries for manual transactions</p>
        </div>
        <button type="button" class="btn btn-back" onclick="goBack()">
            ← Back
        </button>
    </div>

    <!-- Main Form Container with Shadow -->
    <div class="form-container">
        <form method="post" id="journal-entry-form">
            {% csrf_token %}
            
            <!-- Journal Entry Details Section -->
            <div class="form-section">
                <div class="section-header">
                    <h5 class="mb-0">Entry Information</h5>
                </div>
                <div class="section-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
                            {{ form.date }}
                            {% if form.date.errors %}
                                <div class="text-danger">{{ form.date.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="text-danger">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entry Lines Section -->
            <div class="form-section">
                <div class="section-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Journal Entry Lines</h5>
                        <button type="button" id="add-row" class="btn btn-add" title="Add Line">
                            + Add Line
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    {{ lines.management_form }}
                    
                    <div class="table-responsive">
                        <table class="table table-minimal" id="journal-lines-table">
                            <thead>
                                <tr>
                                    <th style="width: 35%">Account</th>
                                    <th style="width: 30%">Description</th>
                                    <th style="width: 15%">Debit</th>
                                    <th style="width: 15%">Credit</th>
                                    <th style="width: 5%">Action</th>
                                </tr>
                            </thead>
                            <tbody id="line-items">
                                {% for form in lines %}
                                <tr class="journal-line-row">
                                    <td>
                                        <div class="form-group">
                                            {{ form.account }}
                                            {% if form.account.errors %}
                                                <div class="text-danger small">{{ form.account.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group">
                                            {{ form.description }}
                                            {% if form.description.errors %}
                                                <div class="text-danger small">{{ form.description.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group">
                                            {{ form.debit }}
                                            {% if form.debit.errors %}
                                                <div class="text-danger small">{{ form.debit.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group">
                                            {{ form.credit }}
                                            {% if form.credit.errors %}
                                                <div class="text-danger small">{{ form.credit.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if not forloop.first %}
                                            <button type="button" class="btn btn-remove remove-line-btn" title="Remove Line">×</button>
                                        {% endif %}
                                    </td>
                                    <!-- Hidden fields for formset -->
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Hidden Empty Form Template -->
                    <div id="empty-form" class="d-none">
                        <tr class="journal-line-row">
                            <td>
                                <div class="form-group">
                                    {{ lines.empty_form.account }}
                                </div>
                            </td>
                            <td>
                                <div class="form-group">
                                    {{ lines.empty_form.description }}
                                </div>
                            </td>
                            <td>
                                <div class="form-group">
                                    {{ lines.empty_form.debit }}
                                </div>
                            </td>
                            <td>
                                <div class="form-group">
                                    {{ lines.empty_form.credit }}
                                </div>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-remove remove-line-btn" title="Remove Line">×</button>
                            </td>
                        </tr>
                    </div>

                    <!-- Balance Summary -->
                    <div class="row mt-4 pt-3 border-top">
                        <div class="col-md-4">
                            <label class="form-label">Total Debits</label>
                            <div class="balance-display" id="debit-total">{{ request.user.company.currency_symbol|default:"$" }}0.00</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Total Credits</label>
                            <div class="balance-display" id="credit-total">{{ request.user.company.currency_symbol|default:"$" }}0.00</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Balance Check</label>
                            <div id="balance-check" class="balance-status"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="goBack()">
                    Cancel
                </button>
                <button class="btn btn-save" type="submit">
                    Save Journal Entry
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const lineItemsContainer = document.getElementById('line-items');
    const addRowButton = document.getElementById('add-row');
    const totalFormsInput = document.querySelector('#id_lines-TOTAL_FORMS');
    const emptyFormTemplate = document.getElementById('empty-form').innerHTML;

    // Update totals and balance check
    function updateTotals() {
        let totalDebit = 0;
        let totalCredit = 0;
        const debitInputs = document.querySelectorAll('input[name*="debit"]');
        const creditInputs = document.querySelectorAll('input[name*="credit"]');
        
        debitInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalDebit += value;
        });
        
        creditInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalCredit += value;
        });

        // Update display
        const currencySymbol = '{{ request.user.company.currency_symbol|default:"$" }}';
        document.getElementById('debit-total').textContent = `${currencySymbol}${totalDebit.toFixed(2)}`;
        document.getElementById('credit-total').textContent = `${currencySymbol}${totalCredit.toFixed(2)}`;

        // Balance check
        const balanceCheck = document.getElementById('balance-check');
        const difference = Math.abs(totalDebit - totalCredit);
        
        if (difference < 0.01) { // Allow for small rounding differences
            balanceCheck.textContent = '✓ Balanced';
            balanceCheck.className = 'balance-status balanced';
        } else {
            balanceCheck.textContent = `⚠ Out of balance by ${difference.toFixed(2)}`;
            balanceCheck.className = 'balance-status unbalanced';
        }
    }

    // Add new line
    addRowButton.addEventListener('click', function() {
        let formNum = parseInt(totalFormsInput.value);
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formNum);
        lineItemsContainer.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = formNum + 1;
        updateTotals();
    });

    // Remove line functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-line-btn')) {
            const row = e.target.closest('.journal-line-row');
            const deleteInput = row.querySelector('input[name*="DELETE"]');
            
            if (deleteInput) {
                deleteInput.value = 'on';
                row.style.display = 'none';
            } else {
                row.remove();
                // Update form count
                const currentTotal = parseInt(totalFormsInput.value);
                totalFormsInput.value = currentTotal - 1;
            }
            updateTotals();
        }
    });

    // Listen for input changes
    document.getElementById('journal-entry-form').addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.includes('debit') || e.target.name.includes('credit'))) {
            updateTotals();
        }
    });

    // Form validation before submit
    document.getElementById('journal-entry-form').addEventListener('submit', function(e) {
        const debitTotal = parseFloat(document.getElementById('debit-total').textContent.replace(/[^\d.-]/g, ''));
        const creditTotal = parseFloat(document.getElementById('credit-total').textContent.replace(/[^\d.-]/g, ''));
        
        if (Math.abs(debitTotal - creditTotal) > 0.01) {
            e.preventDefault();
            alert('Journal entry must be balanced. Debits must equal Credits.');
            return false;
        }
        
        if (debitTotal === 0) {
            e.preventDefault();
            alert('Journal entry cannot have zero amounts.');
            return false;
        }
    });

    // Initial calculation on page load
    updateTotals();
});

// Utility function for going back
function goBack() {
    if (document.referrer && document.referrer !== window.location.href) {
        window.history.back();
    } else {
        window.location.href = '/journal/';
    }
}
</script>

<!-- Consistent Styling -->
<style>
/* Container with shadow - Same as transaction form */
.form-container {
    background: #ffffff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 1px solid #e0e0e0;
    padding: 0;
    margin-bottom: 2rem;
}

/* Form sections */
.form-section {
    border-bottom: 1px solid #f0f0f0;
}

.form-section:last-child {
    border-bottom: none;
}

.section-header {
    background: #f8f9fa;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.section-header h5 {
    color: #2c3e50;
    font-weight: 600;
    margin: 0;
}

.section-body {
    padding: 1.5rem;
}

/* Buttons - Same color scheme */
.btn {
    border: none;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-back {
    background: #6c757d;
    color: white;
}

.btn-back:hover {
    background: #5a6268;
    color: white;
}

.btn-save {
    background: #343a40;
    color: white;
}

.btn-save:hover {
    background: #23272b;
    color: white;
}

.btn-cancel {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.btn-cancel:hover {
    background: #e9ecef;
    color: #5a6268;
}

.btn-add {
    background: #28a745;
    color: white;
    padding: 6px 12px;
    font-size: 12px;
}

.btn-add:hover {
    background: #218838;
    color: white;
}

.btn-remove {
    background: #dc3545;
    color: white;
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-remove:hover {
    background: #c82333;
    color: white;
}

/* Form controls */
.form-control, .form-select {
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 14px;
    width: 100%;
}

.form-control:focus, .form-select:focus {
    border-color: #495057;
    box-shadow: 0 0 0 0.2rem rgba(73, 80, 87, 0.25);
}

/* Form groups in table cells */
.form-group {
    margin: 0;
}

/* Table styling */
.table-minimal {
    font-size: 14px;
    border-collapse: collapse;
}

.table-minimal th {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 12px 8px;
    font-weight: 600;
    color: #495057;
}

.table-minimal td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: middle;
}

/* Balance display */
.balance-display {
    background: #f8f9fa;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    font-weight: 600;
    font-size: 16px;
}

.balance-status {
    padding: 8px 12px;
    font-weight: 600;
    font-size: 14px;
}

.balance-status.balanced {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.balance-status.unbalanced {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Form actions */
.form-actions {
    padding: 1.5rem;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* Error messages */
.text-danger {
    color: #dc3545 !important;
    font-size: 12px;
    margin-top: 2px;
}

/* Remove all border radius */
.btn, .form-control, .form-select, .form-container, .section-header, .balance-display, .balance-status {
    border-radius: 0 !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .form-container {
        margin: 0 -15px;
    }
    
    .section-body {
        padding: 1rem;
    }
    
    .form-actions {
        padding: 1rem;
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        margin-bottom: 8px;
    }
    
    .table-responsive {
        font-size: 12px;
    }
}
</style>
{% endblock %}
