<!-- C:\Users\Adeyanju Joshua\Desktop\lexy sofware\accounting_system_2\apps\transactions\templates\transactions\transaction_form.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Page Header with Back Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0 text-dark">{{ page_title }}</h2>
            <p class="text-muted mb-0 small">Create or edit transaction details</p>
        </div>
        <button type="button" class="btn btn-back" onclick="goBack()">
            ← Back
        </button>
    </div>

    <!-- Main Form Container -->
    <div class="form-container">
        <form method="post" enctype="multipart/form-data" id="transaction-form" novalidate>
            {% csrf_token %}
            
            <!-- Hidden field for total amount, used by backend -->
            <input type="hidden" name="total_amount" id="calculated_total" value="{{ transaction.total_amount|default:'0.00' }}">
            
            <!-- Transaction Details Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <h5 class="mb-0">Transaction Information</h5>
                </div>
                <div class="section-body">
                    <div class="row">
                        <div class="col-md-3">{{ form.transaction_type|as_crispy_field }}</div>
                        <div class="col-md-5">
                            <div class="position-relative">
                                {{ form.customer_search|as_crispy_field }}
                                {{ form.customer }}
                            </div>
                        </div>
                        <div class="col-md-2">{{ form.date|as_crispy_field }}</div>
                        <div class="col-md-2">{{ form.due_date|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-3" id="category-wrapper">{{ form.category|as_crispy_field }}</div>
                        <div class="col-md-3">{{ form.reference_number|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.description|as_crispy_field }}</div>
                    </div>
                     <div class="row">
                        <div class="col-md-12">{{ form.attachment|as_crispy_field }}</div>
                    </div>
                </div>
            </div>

            <!-- Line Items / Splits Section -->
            <div class="form-section mb-4">
                <div class="section-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Transaction Details</h5>
                        <div class="form-check form-switch">
                            {{ form.use_line_items }}
                            <label class="form-check-label" for="{{ form.use_line_items.id_for_label }}">
                                Use Inventory Items
                            </label>
                        </div>
                    </div>
                </div>
                <div class="section-body p-0">
                    <!-- Inventory Line Items Table -->
                    <div id="line-items-section" style="display:none;">
                        <div class="table-responsive">
                            <table class="table table-minimal" id="line-items-table">
                                <thead>
                                    <tr>
                                        <th style="width:35%">Item/Product</th>
                                        <th style="width:20%">Description</th>
                                        <th style="width:6%; text-align:center;">Unit</th>
                                        <th style="width:8%; text-align:center;">Available</th>
                                        <th style="width:8%">Quantity</th>
                                        <th style="width:11%">Unit Price</th>
                                        <th style="width:10%; text-align:right;">Total</th>
                                        <th style="width:2%"></th>
                                    </tr>
                                </thead>
                                <tbody class="formset-container">
                                    {% for item_form in formset.forms %}
                                        <tr class="line-item-row formset-row" id="form-{{ forloop.counter0 }}">
                                            <td>
                                                <div class="input-group">
                                                    {{ item_form.item_type_filter }}
                                                    {{ item_form.item_search }}
                                                    {{ item_form.item }}
                                                </div>
                                            </td>
                                            <td>{{ item_form.description }}</td>
                                            <td><span class="unit-display text-muted small d-block text-center pt-2"></span></td>
                                            <td><span class="available-qty-display text-muted small d-block text-center pt-2"></span></td>
                                            <td>{{ item_form.quantity }}</td>
                                            <td>{{ item_form.unit_price }}</td>
                                            <td class="line-total-display text-end pt-2">0.00</td>
                                            <td class="text-center pt-1">
                                                <button type="button" class="btn btn-danger btn-sm btn-remove remove-row-btn" title="Remove Row">×</button>
                                            </td>
                                            {{ item_form.id }}
                                            {% if item_form.DELETE %}<input type="hidden" name="{{ item_form.DELETE.html_name }}" id="{{ item_form.DELETE.id_for_label }}">{% endif %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="8">
                                            <button type="button" class="btn btn-secondary btn-sm" id="add-row-btn">
                                                + Add Item Line
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {{ formset.management_form }}
                    </div>

                    <!-- Expense Split Table -->
                    <div id="expense-lines-section" style="display:none;">
                        <div class="p-3 border-bottom">
                            <p class="text-muted small mb-0">Allocate the total amount across multiple expense or asset accounts. The category field will be ignored.</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-minimal" id="expense-lines-table">
                                <thead>
                                    <tr>
                                        <th style="width:45%">Account</th>
                                        <th style="width:20%">Amount</th>
                                        <th style="width:30%">Description</th>
                                        <th style="width:5%"></th>
                                    </tr>
                                </thead>
                                <tbody class="expense-formset-container">
                                    {% for expense_form in expense_formset.forms %}
                                        <tr class="expense-line-row formset-row">
                                            <td>{{ expense_form.account }}</td>
                                            <td>{{ expense_form.amount }}</td>
                                            <td>{{ expense_form.description }}</td>
                                            <td class="text-center pt-1">
                                                <button type="button" class="btn btn-danger btn-sm btn-remove remove-expense-row-btn" title="Remove Row">×</button>
                                            </td>
                                            {{ expense_form.id }}
                                            {% if expense_form.DELETE %}<input type="hidden" name="{{ expense_form.DELETE.html_name }}" id="{{ expense_form.DELETE.id_for_label }}">{% endif %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4">
                                            <button type="button" class="btn btn-secondary btn-sm" id="add-expense-row-btn">
                                                + Add Account Line
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {{ expense_formset.management_form }}
                    </div>
                </div>
            </div>

            <!-- Summary & Payment Section -->
            <div class="form-section">
                 <div class="section-header"><h5 class="mb-0">Summary & Payment</h5></div>
                 <div class="section-body">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-8">{{ form.amount_paid|as_crispy_field }}</div>
                                <div class="col-md-4 pt-4">
                                    <div class="form-check">
                                        {{ form.paid_in_full }}
                                        <label for="{{ form.paid_in_full.id_for_label }}" class="form-check-label">Mark as Fully Paid</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="summary-box">
                                <div class="summary-item">
                                    <span>Total Amount</span>
                                    <span id="summary-total">{{ currency_symbol }}0.00</span>
                                </div>
                                <div class="summary-item grand-total">
                                    <span>Balance Due</span>
                                    <span id="summary-balance">{{ currency_symbol }}0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="goBack()">Cancel</button>
                <button class="btn btn-save" type="submit">
                    {% if transaction %}Update Transaction{% else %}Save Transaction{% endif %}
                </button>
            </div>
        </form>

        <!-- Templates for new formset rows -->
        <div class="d-none">
            <template id="empty-form-template">
                <tr class="line-item-row formset-row" id="form-__prefix__">
                    <td>
                        <div class="input-group">
                            {{ formset.empty_form.item_type_filter }}
                            {{ formset.empty_form.item_search }}
                            {{ formset.empty_form.item }}
                        </div>
                    </td>
                    <td>{{ formset.empty_form.description }}</td>
                    <td><span class="unit-display text-muted small d-block text-center pt-2"></span></td>
                    <td><span class="available-qty-display text-muted small d-block text-center pt-2"></span></td>
                    <td>{{ formset.empty_form.quantity }}</td>
                    <td>{{ formset.empty_form.unit_price }}</td>
                    <td class="line-total-display text-end pt-2">0.00</td>
                    <td class="text-center pt-1"><button type="button" class="btn btn-danger btn-sm btn-remove remove-row-btn" title="Remove Row">×</button></td>
                    {{ formset.empty_form.id }}
                </tr>
            </template>
            <template id="empty-expense-form-template">
                <tr class="expense-line-row formset-row">
                    <td>{{ expense_formset.empty_form.account }}</td>
                    <td>{{ expense_formset.empty_form.amount }}</td>
                    <td>{{ expense_formset.empty_form.description }}</td>
                    <td class="text-center pt-1"><button type="button" class="btn btn-danger btn-sm btn-remove remove-expense-row-btn" title="Remove Row">×</button></td>
                    {{ expense_formset.empty_form.id }}
                </tr>
            </template>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<!-- ========================================================================================= -->
<!-- =============================  START: DEFINITIVE FIXES  ================================ -->
<!-- ========================================================================================= -->

<!-- FIX #1: Force dropdown to appear on top with a high z-index -->
<style>
    .smart-search-dropdown {
        z-index: 9999 !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const currencySymbol = '{{ currency_symbol|escapejs }}';

    // --- FORM ELEMENTS ---
    const useLineItemsCheckbox = document.getElementById('id_use_line_items');
    const lineItemsSection = document.getElementById('line-items-section');
    const expenseLinesSection = document.getElementById('expense-lines-section');
    const categoryWrapper = document.getElementById('category-wrapper');
    const paidInFullCheckbox = document.getElementById('id_paid_in_full');
    const amountPaidInput = document.getElementById('id_amount_paid');
    const transactionForm = document.getElementById('transaction-form');

    // --- INITIALIZE CUSTOMER SMART SEARCH ---
    const customerSearchInput = document.getElementById('id_customer_search');
    if (customerSearchInput) {
        new window.SmartSearch(customerSearchInput, '{% url "customers:api_search" %}', {
            allowCreate: true, createUrl: '{% url "customers:api_create" %}', placeholder: 'Search customers or vendors...', currencySymbol: currencySymbol 
        });
    }

    // --- INVENTORY ITEM FORMSET MANAGEMENT ---
    const itemFormsetContainer = document.querySelector('.formset-container');
    const itemTotalFormsInput = document.querySelector('input[name="items-TOTAL_FORMS"]');
    const addRowButton = document.getElementById('add-row-btn');

    /**
     * FIX #2: Robust item search initialization and filter handling.
     * This new function explicitly updates the search URL and re-triggers the search
     * when the item type filter is changed.
     */
    function initializeItemSearch(target) {
        if (!target || target.dataset.smartSearchInitialized) return;
        target.dataset.smartSearchInitialized = 'true';

        const baseSearchUrl = '{% url "inventory:api_items_search" %}';
        const row = target.closest('.line-item-row');
        const filter = row.querySelector('.line-item-type-filter');

        const initialItemType = filter ? filter.value : '';
        const initialSearchUrl = initialItemType ? `${baseSearchUrl}?item_type=${initialItemType}` : baseSearchUrl;

        const smartSearch = new window.SmartSearch(target, initialSearchUrl, {
            placeholder: 'Search products & services...',
            allowCreate: false,
            currencySymbol: currencySymbol,
            dropdownParent: document.body, // Ensures correct positioning
            renderItem: function(item) {
                const type_map = {
                    'stock_item': 'Stock',
                    'finished_good': 'Finished Good',
                    'service': 'Service'
                };
                const itemType = type_map[item.item_type] || 'Item';
                return `<div class="d-flex justify-content-between align-items-center"><span>${item.name}</span><span class="badge-minimal-info">${itemType}</span></div>`;
            }
        });

        target.smartSearchInstance = smartSearch;

        target.addEventListener('smartselect', e => {
            populateRowData(row, e.detail.item);
        });

        if (filter) {
            filter.addEventListener('change', () => {
                // 1. Clear previous selection and all related fields
                target.value = '';
                row.querySelector('input[name$="-item"]').value = '';
                row.querySelector('input[name$="-description"]').value = '';
                row.querySelector('.unit-display').textContent = '';
                row.querySelector('.available-qty-display').textContent = '';
                row.querySelector('input[name$="-quantity"]').value = '';
                row.querySelector('input[name$="-unit_price"]').value = '';
                updateRowTotal(row); // Recalculates line and grand totals

                // 2. Get the new filter value
                const itemType = filter.value;
                
                // 3. Explicitly update the search URL on the SmartSearch instance
                if (itemType) {
                    target.smartSearchInstance.options.searchUrl = `${baseSearchUrl}?item_type=${itemType}`;
                } else {
                    target.smartSearchInstance.options.searchUrl = baseSearchUrl;
                }

                // 4. Manually trigger a search and focus the input to show the new filtered list
                target.smartSearchInstance.search('');
                target.focus();
            });
        }
    }

    function populateRowData(row, data) {
        if (!row || !data) return;
        row.querySelector('input[name$="-item"]').value = data.id;
        const descInput = row.querySelector('input[name$="-description"]');
        if (descInput) descInput.value = data.description || '';
        row.querySelector('.unit-display').textContent = data.unit_of_measurement || 'N/A';
        
        const availableQtyDisplay = row.querySelector('.available-qty-display');
        availableQtyDisplay.textContent = data.quantity_on_hand || '0';
        availableQtyDisplay.dataset.availableQty = data.quantity_on_hand || '0';
        
        const unitPriceInput = row.querySelector('input[name$="-unit_price"]');
        const transactionType = document.getElementById('id_transaction_type').value;
        if (unitPriceInput) {
            unitPriceInput.value = (transactionType === 'SALE' ? data.sale_price : data.purchase_price) || '0.00';
        }
        
        setupQuantityValidation(row);
        updateRowTotal(row);
    }

    function addNewItemRow() {
        if (!itemTotalFormsInput || !itemFormsetContainer) return;
        const formIndex = parseInt(itemTotalFormsInput.value);
        const emptyFormTemplate = document.getElementById('empty-form-template');
        const newRowHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIndex);
        itemFormsetContainer.insertAdjacentHTML('beforeend', newRowHtml);
        itemTotalFormsInput.value = formIndex + 1;
        
        const newRow = itemFormsetContainer.lastElementChild;
        initializeItemSearch(newRow.querySelector('.item-search-input'));
        attachItemRowEventListeners(newRow);
    }

    function removeItemRow(button) {
        const row = button.closest('.line-item-row');
        if (!row) return;
        const deleteInput = row.querySelector('input[name$="-DELETE"]');
        if (deleteInput) {
            deleteInput.value = 'on';
            row.style.display = 'none';
        } else {
            row.remove();
        }
        updateGrandTotal();
    }

    function attachItemRowEventListeners(row) {
        row.querySelector('.remove-row-btn').addEventListener('click', (e) => removeItemRow(e.target));
        row.querySelectorAll('input[name$="-quantity"], input[name$="-unit_price"]').forEach(input => {
            input.addEventListener('input', () => updateRowTotal(row));
        });
        setupQuantityValidation(row);
    }

    // --- EXPENSE SPLIT FORMSET MANAGEMENT ---
    const expenseFormsetContainer = document.querySelector('.expense-formset-container');
    const expenseTotalFormsInput = document.querySelector('input[name="expense_lines-TOTAL_FORMS"]');
    const addExpenseRowButton = document.getElementById('add-expense-row-btn');

    function addNewExpenseRow() {
        if (!expenseTotalFormsInput || !expenseFormsetContainer) return;
        const formIndex = parseInt(expenseTotalFormsInput.value);
        const emptyFormTemplate = document.getElementById('empty-expense-form-template');
        const newRowHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIndex);
        expenseFormsetContainer.insertAdjacentHTML('beforeend', newRowHtml);
        expenseTotalFormsInput.value = formIndex + 1;
        attachExpenseRowEventListeners(expenseFormsetContainer.lastElementChild);
    }

    function removeExpenseRow(button) {
        const row = button.closest('.expense-line-row');
        if (!row) return;
        const deleteInput = row.querySelector('input[name$="-DELETE"]');
        if (deleteInput) {
            deleteInput.value = 'on';
            row.style.display = 'none';
        } else {
            row.remove();
        }
        updateGrandTotal();
    }

    function attachExpenseRowEventListeners(row) {
        row.querySelector('.remove-expense-row-btn').addEventListener('click', (e) => removeExpenseRow(e.target));
        row.querySelector('input[name$="-amount"]').addEventListener('input', updateGrandTotal);
    }

    // --- CALCULATION & VALIDATION LOGIC ---
    function updateRowTotal(row) {
        const quantity = parseFloat(row.querySelector('input[name$="-quantity"]')?.value) || 0;
        const unitPrice = parseFloat(row.querySelector('input[name$="-unit_price"]')?.value) || 0;
        const totalDisplay = row.querySelector('.line-total-display');
        if (totalDisplay) {
            totalDisplay.textContent = (quantity * unitPrice).toFixed(2);
        }
        updateGrandTotal();
    }

    function updateGrandTotal() {
        let grandTotal = 0;
        if (useLineItemsCheckbox.checked) {
            document.querySelectorAll('.line-item-row:not([style*="display: none"])').forEach(row => {
                grandTotal += parseFloat(row.querySelector('.line-total-display').textContent) || 0;
            });
        } else {
            document.querySelectorAll('.expense-line-row:not([style*="display: none"])').forEach(row => {
                grandTotal += parseFloat(row.querySelector('input[name$="-amount"]').value) || 0;
            });
        }
        
        document.getElementById('calculated_total').value = grandTotal.toFixed(2);
        document.getElementById('summary-total').textContent = `${currencySymbol}${grandTotal.toFixed(2)}`;
        updateBalanceDue();
    }

    function updateBalanceDue() {
        const total = parseFloat(document.getElementById('calculated_total').value) || 0;
        const paid = parseFloat(amountPaidInput.value) || 0;
        const balance = total - paid;
        document.getElementById('summary-balance').textContent = `${currencySymbol}${balance.toFixed(2)}`;
    }

    function setupQuantityValidation(row) {
        const quantityInput = row.querySelector('input[name$="-quantity"]');
        if (quantityInput) {
            quantityInput.addEventListener('input', () => validateQuantity(row));
            validateQuantity(row); // Initial check
        }
    }

    function validateQuantity(row) {
        const transactionType = document.getElementById('id_transaction_type').value;
        if (transactionType !== 'SALE') return true;
        
        const quantityInput = row.querySelector('input[name$="-quantity"]');
        const availableQtyDisplay = row.querySelector('.available-qty-display');
        const quantity = parseFloat(quantityInput.value) || 0;
        const availableQty = parseFloat(availableQtyDisplay.dataset.availableQty) || 0;
        
        const errorMsg = row.querySelector('.quantity-error-msg');
        if (errorMsg) errorMsg.remove();
        quantityInput.classList.remove('is-invalid');
        
        if (quantity > availableQty) {
            quantityInput.classList.add('is-invalid');
            const newErrorMsg = document.createElement('div');
            newErrorMsg.className = 'invalid-feedback quantity-error-msg';
            newErrorMsg.textContent = `Exceeds stock (${availableQty})`;
            quantityInput.parentNode.appendChild(newErrorMsg);
            return false;
        }
        return true;
    }

    function validateAllQuantities() {
        if (document.getElementById('id_transaction_type').value !== 'SALE') return true;
        let isValid = true;
        document.querySelectorAll('.line-item-row:not([style*="display: none"])').forEach(row => {
            if (!validateQuantity(row)) isValid = false;
        });
        return isValid;
    }

    // --- UI TOGGLING & MAIN EVENT HANDLERS ---
    function toggleSections() {
        const useLineItems = useLineItemsCheckbox.checked;
        lineItemsSection.style.display = useLineItems ? 'block' : 'none';
        expenseLinesSection.style.display = useLineItems ? 'none' : 'block';
        categoryWrapper.style.display = useLineItems ? 'block' : 'none';
        updateGrandTotal();
    }

    function handlePaidInFullChange() {
        if (paidInFullCheckbox.checked) {
            const total = document.getElementById('calculated_total').value;
            amountPaidInput.value = parseFloat(total).toFixed(2);
            amountPaidInput.readOnly = true;
        } else {
            amountPaidInput.readOnly = false;
        }
        updateBalanceDue();
    }

    // --- ATTACH EVENT LISTENERS ---
    useLineItemsCheckbox.addEventListener('change', toggleSections);
    paidInFullCheckbox.addEventListener('change', handlePaidInFullChange);
    amountPaidInput.addEventListener('input', updateBalanceDue);
    
    // Item formset listeners
    if (addRowButton) addRowButton.addEventListener('click', addNewItemRow);
    document.querySelectorAll('.line-item-row').forEach(row => {
        initializeItemSearch(row.querySelector('.item-search-input'));
        attachItemRowEventListeners(row);
    });

    // Expense formset listeners
    if (addExpenseRowButton) addExpenseRowButton.addEventListener('click', addNewExpenseRow);
    document.querySelectorAll('.expense-line-row').forEach(attachExpenseRowEventListeners);

    // Form submission validation
    transactionForm.addEventListener('submit', (e) => {
        if (useLineItemsCheckbox.checked && !validateAllQuantities()) {
            e.preventDefault();
            alert('Cannot proceed. Some item quantities exceed available stock.');
            return;
        }
        if (amountPaidInput.readOnly) amountPaidInput.readOnly = false;
    });

    // --- INITIAL STATE SETUP ---
    toggleSections();
    document.querySelectorAll('.line-item-row').forEach(updateRowTotal);
    if (!useLineItemsCheckbox.checked) {
        updateGrandTotal();
    }
    if (paidInFullCheckbox.checked) handlePaidInFullChange();
});

function goBack() {
    window.history.length > 1 ? window.history.back() : window.location.href = '{% url "transactions:transaction_list" %}';
}
</script>
{% endblock scripts %}